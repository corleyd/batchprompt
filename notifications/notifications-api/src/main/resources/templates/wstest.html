<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BatchPrompt Notification Test</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            display: flex;
            gap: 20px;
        }
        .column {
            flex: 1;
        }
        .connection-status {
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 4px;
        }
        .connected { background-color: #dff0d8; color: #3c763d; }
        .disconnected { background-color: #f2dede; color: #a94442; }
        .connecting { background-color: #fcf8e3; color: #8a6d3b; }
        input, select, button, textarea {
            margin: 5px 0;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box;
        }
        button {
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
            border: none;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .card {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .notification-list {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .notification {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        .notification pre {
            white-space: pre-wrap;
            word-break: break-all;
            margin: 5px 0;
        }
        .notification:last-child {
            border-bottom: none;
        }
        .notification-jobs { background-color: #e8f4f8; }
        .notification-tasks { background-color: #f0f8e8; }
        .notification-files { background-color: #f8f0e8; }
        .notification-system { background-color: #f8e8f0; }
    </style>
</head>
<body>
    <h1>BatchPrompt Notification Testing</h1>
    
    <div class="container">
        <div class="column">
            <div id="connectionStatus" class="connection-status disconnected">
                Disconnected
            </div>
            
            <div class="card">
                <h2>Connection</h2>
                <input type="text" id="tokenInput" placeholder="Enter JWT Token" />
                <button id="connectButton">Connect</button>
                <button id="disconnectButton" disabled>Disconnect</button>
            </div>
            
            <div class="card">
                <h2>Subscribe to Topics</h2>
                <div>
                    <label>
                        <input type="checkbox" id="allNotificationsCheckbox" checked>
                        All Notifications (/topic/notifications)
                    </label>
                </div>
                <div>
                    <label>
                        <input type="checkbox" id="jobsCheckbox" checked>
                        Jobs (/topic/jobs)
                    </label>
                </div>
                <div>
                    <label>
                        <input type="checkbox" id="tasksCheckbox" checked>
                        Tasks (/topic/tasks)
                    </label>
                </div>
                <div>
                    <label>
                        <input type="checkbox" id="filesCheckbox" checked>
                        Files (/topic/files)
                    </label>
                </div>
                <div>
                    <label>
                        <input type="checkbox" id="systemCheckbox" checked>
                        System (/topic/system)
                    </label>
                </div>
                <div>
                    <input type="text" id="customTopic" placeholder="Custom topic (e.g., /topic/jobs/{uuid})">
                    <button id="subscribeCustomButton">Subscribe</button>
                </div>
            </div>
            
            <div class="card">
                <h2>Send Test Notifications</h2>
                <select id="notificationType">
                    <option value="job">Job Status</option>
                    <option value="task">Task Status</option>
                    <option value="file">File Status</option>
                    <option value="system">System</option>
                </select>
                
                <div id="jobParams">
                    <input type="text" id="jobUuid" placeholder="Job UUID (optional - random if empty)">
                    <input type="text" id="jobNewStatus" placeholder="New Status" value="COMPLETED">
                    <input type="text" id="jobPrevStatus" placeholder="Previous Status" value="PROCESSING">
                </div>
                
                <div id="taskParams" style="display:none;">
                    <input type="text" id="taskJobUuid" placeholder="Job UUID (optional - random if empty)">
                    <input type="text" id="taskUuid" placeholder="Task UUID (optional - random if empty)">
                    <input type="text" id="taskNewStatus" placeholder="New Status" value="COMPLETED">
                    <input type="text" id="taskPrevStatus" placeholder="Previous Status" value="PROCESSING">
                </div>
                
                <div id="fileParams" style="display:none;">
                    <input type="text" id="fileUuid" placeholder="File UUID (optional - random if empty)">
                    <input type="text" id="fileNewStatus" placeholder="New Status" value="PROCESSED">
                    <input type="text" id="filePrevStatus" placeholder="Previous Status" value="UPLOADING">
                </div>
                
                <div id="systemParams" style="display:none;">
                    <input type="text" id="systemMessage" placeholder="System Message" value="System is running normally">
                </div>
                
                <button id="sendNotificationButton">Send Test Notification</button>
            </div>
        </div>
        
        <div class="column">
            <div class="card">
                <h2>Received Notifications</h2>
                <button id="clearNotificationsButton">Clear</button>
                <div id="notificationList" class="notification-list"></div>
            </div>
        </div>
    </div>
    
    <script>
        let stompClient = null;
        let subscriptions = {};
        
        // DOM elements
        const connectionStatus = document.getElementById('connectionStatus');
        const connectButton = document.getElementById('connectButton');
        const disconnectButton = document.getElementById('disconnectButton');
        const tokenInput = document.getElementById('tokenInput');
        const notificationList = document.getElementById('notificationList');
        const clearNotificationsButton = document.getElementById('clearNotificationsButton');
        const notificationType = document.getElementById('notificationType');
        const sendNotificationButton = document.getElementById('sendNotificationButton');
        const customTopic = document.getElementById('customTopic');
        const subscribeCustomButton = document.getElementById('subscribeCustomButton');
        
        // Parameter divs
        const jobParams = document.getElementById('jobParams');
        const taskParams = document.getElementById('taskParams');
        const fileParams = document.getElementById('fileParams');
        const systemParams = document.getElementById('systemParams');
        
        // Checkbox elements
        const allNotificationsCheckbox = document.getElementById('allNotificationsCheckbox');
        const jobsCheckbox = document.getElementById('jobsCheckbox');
        const tasksCheckbox = document.getElementById('tasksCheckbox');
        const filesCheckbox = document.getElementById('filesCheckbox');
        const systemCheckbox = document.getElementById('systemCheckbox');
        
        // Handle notification type change
        notificationType.addEventListener('change', function() {
            // Hide all parameter divs
            jobParams.style.display = 'none';
            taskParams.style.display = 'none';
            fileParams.style.display = 'none';
            systemParams.style.display = 'none';
            
            // Show the selected type
            switch(this.value) {
                case 'job':
                    jobParams.style.display = 'block';
                    break;
                case 'task':
                    taskParams.style.display = 'block';
                    break;
                case 'file':
                    fileParams.style.display = 'block';
                    break;
                case 'system':
                    systemParams.style.display = 'block';
                    break;
            }
        });
        
        // Connect to WebSocket
        connectButton.addEventListener('click', function() {
            if (stompClient) {
                disconnect();
            }
            connect();
        });
        
        // Disconnect from WebSocket
        disconnectButton.addEventListener('click', function() {
            disconnect();
        });
        
        // Clear notifications
        clearNotificationsButton.addEventListener('click', function() {
            notificationList.innerHTML = '';
        });
        
        // Send test notification
        sendNotificationButton.addEventListener('click', function() {
            sendTestNotification();
        });
        
        // Subscribe to custom topic
        subscribeCustomButton.addEventListener('click', function() {
            const topic = customTopic.value.trim();
            if (topic && stompClient && stompClient.connected) {
                subscribeToTopic(topic);
            }
        });
        
        // Checkbox change handlers
        allNotificationsCheckbox.addEventListener('change', handleCheckboxChange);
        jobsCheckbox.addEventListener('change', handleCheckboxChange);
        tasksCheckbox.addEventListener('change', handleCheckboxChange);
        filesCheckbox.addEventListener('change', handleCheckboxChange);
        systemCheckbox.addEventListener('change', handleCheckboxChange);
        
        function handleCheckboxChange(event) {
            const checkbox = event.target;
            const topic = getTopicFromCheckbox(checkbox.id);
            
            if (stompClient && stompClient.connected) {
                if (checkbox.checked) {
                    subscribeToTopic(topic);
                } else {
                    unsubscribeFromTopic(topic);
                }
            }
        }
        
        function getTopicFromCheckbox(id) {
            switch(id) {
                case 'allNotificationsCheckbox': return '/topic/notifications';
                case 'jobsCheckbox': return '/topic/jobs';
                case 'tasksCheckbox': return '/topic/tasks';
                case 'filesCheckbox': return '/topic/files';
                case 'systemCheckbox': return '/topic/system';
                default: return null;
            }
        }
        
        function connect() {
            const token = tokenInput.value.trim();
            if (!token) {
                alert('Please enter a JWT token');
                return;
            }
            
            // Update UI state
            connectionStatus.className = 'connection-status connecting';
            connectionStatus.innerText = 'Connecting...';
            connectButton.disabled = true;
            
            // Create SockJS instance with token
            const socket = new SockJS(`/ws?token=${token}`);
            stompClient = Stomp.over(socket);
            
            // Disable debug logging
            stompClient.debug = null;
            
            // Connect to the WebSocket server
            stompClient.connect({
                'Authorization': `Bearer ${token}`
            }, 
            function(frame) {
                // Connected successfully
                connectionStatus.className = 'connection-status connected';
                connectionStatus.innerText = `Connected as ${frame.headers['user-name'] || 'anonymous'}`;
                connectButton.disabled = true;
                disconnectButton.disabled = false;
                
                // Subscribe to selected topics
                subscribeToDefaultTopics();
                
                // Send a connection message
                stompClient.send('/app/connect', {}, JSON.stringify({
                    message: 'Client connected from test page'
                }));
                
                addNotification({
                    type: 'SYSTEM',
                    message: `Connected to WebSocket server at ${new Date().toISOString()}`
                }, 'system');
            }, 
            function(error) {
                // Connection error
                connectionStatus.className = 'connection-status disconnected';
                connectionStatus.innerText = `Connection failed: ${error}`;
                connectButton.disabled = false;
                disconnectButton.disabled = true;
                console.error('STOMP connection error:', error);
            });
        }
        
        function subscribeToDefaultTopics() {
            // Subscribe to topics based on checkboxes
            if (allNotificationsCheckbox.checked) {
                subscribeToTopic('/topic/notifications');
            }
            if (jobsCheckbox.checked) {
                subscribeToTopic('/topic/jobs');
            }
            if (tasksCheckbox.checked) {
                subscribeToTopic('/topic/tasks');
            }
            if (filesCheckbox.checked) {
                subscribeToTopic('/topic/files');
            }
            if (systemCheckbox.checked) {
                subscribeToTopic('/topic/system');
            }
            
            // Also subscribe to acknowledgement topic
            subscribeToTopic('/topic/ack');
        }
        
        function subscribeToTopic(topic) {
            if (subscriptions[topic]) {
                console.log(`Already subscribed to ${topic}`);
                return;
            }
            
            const subscription = stompClient.subscribe(topic, function(message) {
                try {
                    const payload = JSON.parse(message.body);
                    const notificationType = getNotificationTypeClass(payload.type);
                    addNotification(payload, notificationType);
                } catch (e) {
                    addNotification({
                        message: message.body,
                        timestamp: new Date().toISOString()
                    }, 'system');
                }
            });
            
            subscriptions[topic] = subscription;
            console.log(`Subscribed to ${topic}`);
        }
        
        function unsubscribeFromTopic(topic) {
            if (subscriptions[topic]) {
                subscriptions[topic].unsubscribe();
                delete subscriptions[topic];
                console.log(`Unsubscribed from ${topic}`);
            }
        }
        
        function getNotificationTypeClass(type) {
            if (!type) return 'system';
            
            switch(type) {
                case 'JOB_STATUS_CHANGED': return 'jobs';
                case 'JOB_TASK_STATUS_CHANGED': return 'tasks';
                case 'FILE_STATUS_CHANGED': return 'files';
                case 'SYSTEM': return 'system';
                default: return '';
            }
        }
        
        function disconnect() {
            if (stompClient) {
                Object.values(subscriptions).forEach(sub => sub.unsubscribe());
                subscriptions = {};
                
                stompClient.disconnect(function() {
                    connectionStatus.className = 'connection-status disconnected';
                    connectionStatus.innerText = 'Disconnected';
                    connectButton.disabled = false;
                    disconnectButton.disabled = true;
                    
                    addNotification({
                        type: 'SYSTEM',
                        message: `Disconnected from WebSocket server at ${new Date().toISOString()}`
                    }, 'system');
                });
                
                stompClient = null;
            }
        }
        
        function addNotification(notification, typeClass) {
            const notificationDiv = document.createElement('div');
            notificationDiv.className = `notification notification-${typeClass}`;
            
            const time = notification.timestamp 
                ? new Date(notification.timestamp).toLocaleTimeString() 
                : new Date().toLocaleTimeString();
            
            notificationDiv.innerHTML = `
                <div><strong>${time}</strong> - ${notification.type || 'MESSAGE'}</div>
                <div>${notification.message || ''}</div>
                <pre>${JSON.stringify(notification, null, 2)}</pre>
            `;
            
            notificationList.prepend(notificationDiv);
        }
        
        function sendTestNotification() {
            const type = notificationType.value;
            let url = `/test/notifications/${type}`;
            let params = new URLSearchParams();
            
            switch(type) {
                case 'job':
                    const jobUuid = document.getElementById('jobUuid').value;
                    if (jobUuid) params.append('jobUuid', jobUuid);
                    params.append('newStatus', document.getElementById('jobNewStatus').value || 'COMPLETED');
                    params.append('previousStatus', document.getElementById('jobPrevStatus').value || 'PROCESSING');
                    break;
                
                case 'task':
                    const taskJobUuid = document.getElementById('taskJobUuid').value;
                    const taskUuid = document.getElementById('taskUuid').value;
                    if (taskJobUuid) params.append('jobUuid', taskJobUuid);
                    if (taskUuid) params.append('taskUuid', taskUuid);
                    params.append('newStatus', document.getElementById('taskNewStatus').value || 'COMPLETED');
                    params.append('previousStatus', document.getElementById('taskPrevStatus').value || 'PROCESSING');
                    break;
                
                case 'file':
                    const fileUuid = document.getElementById('fileUuid').value;
                    if (fileUuid) params.append('fileUuid', fileUuid);
                    params.append('newStatus', document.getElementById('fileNewStatus').value || 'PROCESSED');
                    params.append('previousStatus', document.getElementById('filePrevStatus').value || 'UPLOADING');
                    break;
                
                case 'system':
                    params.append('message', document.getElementById('systemMessage').value || 'System notification');
                    break;
            }
            
            fetch(`${url}?${params.toString()}`, {
                method: 'POST'
            })
            .then(response => response.text())
            .then(result => {
                console.log('Test notification sent:', result);
                addNotification({
                    type: 'SYSTEM',
                    message: `Sent test ${type} notification: ${result}`
                }, 'system');
            })
            .catch(error => {
                console.error('Error sending test notification:', error);
                addNotification({
                    type: 'SYSTEM',
                    message: `Error sending test notification: ${error.message}`
                }, 'system');
            });
        }
    </script>
</body>
</html>
